

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="YuMan-LJP">
  <meta name="keywords" content="">
  
    <meta name="description" content="学习微软官方文档中的验证和授权，再结合自己做过一些项目的经验，搭建一套提供权限控制功能的系统，实现最基础的方法访问权限控制。从零开始搭建，最终效果可以动态配置权限。             1.认证 Authentication1.1.建立新项目 1.1.1.创建一个MVC项目，身份认证类型选择个人账户 不了解顶级语句的可以先参考微软文档介绍：https:&#x2F;&#x2F;learn.">
<meta property="og:type" content="article">
<meta property="og:title" content="【2】学习ASP.NET Identity，搭建一套简易权限控制系统">
<meta property="og:url" content="http://example.com/2023/12/29/StudyAspNetIdentity/index.html">
<meta property="og:site_name" content="YuMan-LJP&#39;s Blog">
<meta property="og:description" content="学习微软官方文档中的验证和授权，再结合自己做过一些项目的经验，搭建一套提供权限控制功能的系统，实现最基础的方法访问权限控制。从零开始搭建，最终效果可以动态配置权限。             1.认证 Authentication1.1.建立新项目 1.1.1.创建一个MVC项目，身份认证类型选择个人账户 不了解顶级语句的可以先参考微软文档介绍：https:&#x2F;&#x2F;learn.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_1(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_1(2).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_2.jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_3(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_3(2).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_2_2(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_2_2(2).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_2_2(3).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_2_2(4).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img1_2_3.jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_2_6(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_2_6(2).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_3_1.jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_4_1.jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_5_7.jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_6_3(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_6_3(2).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_6_3(3).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_7_3(1).jpg">
<meta property="og:image" content="http://example.com/img/StudyAspNetIdentity/img2_7_3(2).jpg">
<meta property="article:published_time" content="2023-12-29T03:18:37.000Z">
<meta property="article:modified_time" content="2024-01-02T00:00:00.000Z">
<meta property="article:author" content="YuMan-LJP">
<meta property="article:tag" content="ASP.NET Identity">
<meta property="article:tag" content="认证">
<meta property="article:tag" content="授权">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/StudyAspNetIdentity/img1_1_1(1).jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>【2】学习ASP.NET Identity，搭建一套简易权限控制系统 - YuMan-LJP&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>YuMan-LJP&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【2】学习ASP.NET Identity，搭建一套简易权限控制系统"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-29 11:18" pubdate>
          2023年12月29日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          90 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">【2】学习ASP.NET Identity，搭建一套简易权限控制系统</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2024年1月2日 早上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <div class="note note-info">
            <p>学习微软官方文档中的验证和授权，再结合自己做过一些项目的经验，搭建一套提供权限控制功能的系统，实现最基础的方法访问权限控制。从零开始搭建，最终效果可以动态配置权限。</p>
          </div>

<h1 id="1-认证-Authentication"><a href="#1-认证-Authentication" class="headerlink" title="1.认证 Authentication"></a>1.认证 Authentication</h1><h2 id="1-1-建立新项目"><a href="#1-1-建立新项目" class="headerlink" title="1.1.建立新项目"></a>1.1.建立新项目</h2><p><a id="section1_1"></a></p>
<h3 id="1-1-1-创建一个MVC项目，身份认证类型选择个人账户"><a href="#1-1-1-创建一个MVC项目，身份认证类型选择个人账户" class="headerlink" title="1.1.1.创建一个MVC项目，身份认证类型选择个人账户"></a>1.1.1.创建一个MVC项目，身份认证类型选择个人账户</h3><p><img src="/../img/StudyAspNetIdentity/img1_1_1(1).jpg" srcset="/img/loading.gif" lazyload alt="创建MVC项目" title="创建MVC项目"></p>
<p>不了解顶级语句的可以先参考微软文档介绍：<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/dotnet/csharp/tutorials/top-level-statements">https://learn.microsoft.com/zh-cn/dotnet/csharp/tutorials/top-level-statements</a><br> <strong>在此使用顶级语句最明显的就是把Startup类省略了，整合到了Program类里面</strong></p>
<p>当前案例项目名称取名为：WebMvc1，后续相关样例代码在这个命名空间下</p>
<p><img src="/../img/StudyAspNetIdentity/img1_1_1(2).jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"><br>如上图项目结构，除了标准的MVC结构之外，Data文件夹下是EF的上下文实例和迁移文件，Areas文件夹下则是最开始选择了个人账户作为身份认证类型之后生成的Identity相关的页面代码文件，核心的页面都涵盖在Identity.UI包里面，这里暂时看不到。</p>
<h3 id="1-1-2-执行EF迁移，生成数据库"><a href="#1-1-2-执行EF迁移，生成数据库" class="headerlink" title="1.1.2.执行EF迁移，生成数据库"></a>1.1.2.执行EF迁移，生成数据库</h3><p>（1）先把当前创建的项目作为启动项，如果已经是就不管，<br>（2）打开appsettings.json文件，配置数据库连接字符串，<br>（3）然后打开程序包管理器控制台，选择默认项目为当前创建的项目，执行命令  <code>Update-Database</code><br> <em><strong>如果执行遇到异常，如提示关于证书相关的，可以在appsettings.json的DefaultConnection字符串后加是 <code>trustServerCertificate=true;</code> 或 <code>encrypt=false;</code></strong></em><br>（4）执行成功后查数据库，如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_1_2.jpg" srcset="/img/loading.gif" lazyload alt="数据库迁移" title="数据库迁移"></p>
<h3 id="1-1-3-启动项目，注册用户"><a href="#1-1-3-启动项目，注册用户" class="headerlink" title="1.1.3.启动项目，注册用户"></a>1.1.3.启动项目，注册用户</h3><p><a id="section1_1_3"></a></p>
<p>（1）项目启动成功后，右上角自带注册和登录按钮，尝试自己注册一个账户，并登录（注意注册成功后需要点击一下页面的“ <strong>Click here to confirm your account</strong> ”来验证邮箱）<br><img src="/../img/StudyAspNetIdentity/img1_1_3(1).jpg" srcset="/img/loading.gif" lazyload alt="启动项目" title="启动项目"><br>（2）登录成功后可以管理自己的账户信息，如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_1_3(2).jpg" srcset="/img/loading.gif" lazyload alt="用户信息页面" title="用户信息页面"><br>注册的用户信息在数据库可以查询到，数据库执行语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> AspNetUsers<br></code></pre></td></tr></table></figure>
<p>（3）查看模板页_Layout.cshtml，会看到视图右上角是引入了一个部分视图_LoginPartial，查看部分视图可以得到这两个按钮的代码，按钮请求的则是Identity域里面的路径，这个则是封装在Identity.UI里面了</p>
<p>（4）在Program类里面补充 <code>app.UseAuthentication();</code> 来启用 Identity（注意按 UseRouting、UseAuthentication 和 UseAuthorization的顺序调用），在Home控制器里面的Privacy方法加上特性 <code>[Authorize]</code> ，再次启动，直接访问Privacy，会自动弹出登录页面，此时已经完成最简单的认证，表示这个方法要授权才能登录，就需要认证用户身份，只要登录即可</p>
<br>

<h2 id="1-2-拓展用户表，搭建基架"><a href="#1-2-拓展用户表，搭建基架" class="headerlink" title="1.2.拓展用户表，搭建基架"></a>1.2.拓展用户表，搭建基架</h2><p>在 <a href="#section1_1">1.1</a> 的基础上，如果我们想拓展用户名的信息，例如加上姓名、生日之类的属性，又或者想修改一下登录页面，信息编辑页面的视图等，则需要进行拓展</p>
<h3 id="1-2-1-拓展用户表"><a href="#1-2-1-拓展用户表" class="headerlink" title="1.2.1.拓展用户表"></a>1.2.1.拓展用户表</h3><p>在Data文件夹下新建ApplicationUser类并继承IdentityUser，修改ApplicationDbContext类，让IdentityDbContext泛型参数传入ApplicationUser</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationUser</span> : <span class="hljs-title">IdentityUser</span><br>&#123;<br>    <span class="hljs-comment">//拓展字段以下三个字段</span><br><br>    [<span class="hljs-meta">PersonalData</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? CustomTag &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">StringLength(200)</span>]<br>    [<span class="hljs-meta">PersonalData</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125; = <span class="hljs-string">&quot;&quot;</span>;<br><br>    [<span class="hljs-meta">PersonalData</span>]<br>    <span class="hljs-keyword">public</span> DateTime? Birthday &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationDbContext</span> : <span class="hljs-title">IdentityDbContext</span>&lt;<span class="hljs-title">ApplicationUser</span>&gt; <span class="hljs-comment">//传入ApplicationUser</span><br>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ApplicationDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ApplicationDbContext&gt; options</span>)</span><br><span class="hljs-function">        : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><br>    &#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnModelCreating</span>(<span class="hljs-params">ModelBuilder builder</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnModelCreating(builder);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>然后程序包管理器控制台执行 <code>Add-Migration Updated_User</code> 会生成迁移日志，然后再执行 <code>Update-Database</code> 更新到数据库中，此时再查数据库用户表，就拓展了三个字段了，需要其他字段按自己需要增加即可</p>
<p>Program类中，将 <code>AddDefaultIdentity&lt;IdentityUser&gt;</code> 改为 <code>AddDefaultIdentity&lt;ApplicationUser&gt;</code> ，</p>
<p>_LoginPartial.cshtml中，将IdentityUser都改为ApplicationUser，改完代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#">@using Microsoft.AspNetCore.Identity<br>@using WebMvc1.Data<br>@inject SignInManager&lt;ApplicationUser&gt; SignInManager<br>@inject UserManager&lt;ApplicationUser&gt; UserManager<br></code></pre></td></tr></table></figure>

<h3 id="1-2-2-搭建基架"><a href="#1-2-2-搭建基架" class="headerlink" title="1.2.2.搭建基架"></a>1.2.2.搭建基架</h3><p>鼠标右键这个项目-&gt;添加-&gt;新搭建基架的项目，选择标识（Identity）添加，如下图所示，DbContext类中选择当前项目的那个EF上下文实例，替代文件勾选 <strong>Account&#x2F;Register</strong> 和 <strong>Account&#x2F;Manage&#x2F;Index</strong> ，主要我们拓展了三个字段，相应增加一下三个字段的维护，只需要改注册页面和用户编辑信息管理的页面即可，此时可以根据自己的需要，也可以选择其他的页面构筑（这里搭建基架的意思就是， <a href="#section1_1_3">1.1.3</a> 我们成功启动项目时，操作的注册页面和登录页面我们项目代码里面是看不到的，因为都被封装在Identity.UI里面了，现在就是要把搭建这个视图页面的源码生成出来，供我们自己重构页面）<br><img src="/../img/StudyAspNetIdentity/img1_2_2(1).jpg" srcset="/img/loading.gif" lazyload alt="搭建基架" title="搭建基架"></p>
<p>生成好基架之后，整体的项目代码如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_2_2(2).jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"></p>
<p>开始调整视图页面，支持三个拓展字段的维护，首先调整注册页面<br>（1）调整Register.cshtml.cs（InputModel类加上三个字段，OnPostAsync方法补充对三个字段的赋值）</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InputModel</span><br>&#123;<br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">DataType(DataType.Text)</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Tag&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> CustomTag &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">DataType(DataType.Text)</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Full name&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Birth Date&quot;</span>)</span>]<br>    [<span class="hljs-meta">DataType(DataType.Date)</span>]<br>    <span class="hljs-keyword">public</span> DateTime? Birthday &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span>     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span>     directly from your code. This API may change or be removed in future releases.</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">EmailAddress</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Email&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Email &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    ......<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">OnPostAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> returnUrl = <span class="hljs-literal">null</span></span>)</span><br>&#123;<br>    returnUrl ??= Url.Content(<span class="hljs-string">&quot;~/&quot;</span>);<br>    ExternalLogins = (<span class="hljs-keyword">await</span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();<br>    <span class="hljs-keyword">if</span> (ModelState.IsValid)<br>    &#123;<br>        <span class="hljs-keyword">var</span> user = CreateUser();<br><br>        user.CustomTag = Input.CustomTag;  <span class="hljs-comment">//补充代码</span><br>        user.Name = Input.Name;            <span class="hljs-comment">//补充代码</span><br>        user.Birthday = Input.Birthday;    <span class="hljs-comment">//补充代码</span><br><br>        <span class="hljs-keyword">await</span> _userStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);<br>        <span class="hljs-keyword">await</span> _emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _userManager.CreateAsync(user, Input.Password);<br><br>        ......<br>    &#125;<br><br>    <span class="hljs-comment">// If we got this far, something failed, redisplay form</span><br>    <span class="hljs-keyword">return</span> Page();<br>&#125;<br><br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（2）调整Register.cshtml视图（视图补充三个字段的输入框）</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;form id=<span class="hljs-string">&quot;registerForm&quot;</span> asp-route-returnUrl=<span class="hljs-string">&quot;@Model.ReturnUrl&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>    &lt;h2&gt;Create a <span class="hljs-keyword">new</span> account.&lt;/h2&gt;<br>    &lt;hr /&gt;<br>    &lt;div asp-validation-summary=<span class="hljs-string">&quot;ModelOnly&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span> role=<span class="hljs-string">&quot;alert&quot;</span>&gt;&lt;/div&gt;<br><br>    @* 补充代码 *@<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating mb-3&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.CustomTag&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> placeholder=<span class="hljs-string">&quot;tag&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.CustomTag&quot;</span>&gt;&lt;/label&gt;<br>        &lt;span asp-validation-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.CustomTag&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating mb-3&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Name&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> aria-required=<span class="hljs-string">&quot;true&quot;</span> placeholder=<span class="hljs-string">&quot;name&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Name&quot;</span>&gt;&lt;/label&gt;<br>        &lt;span asp-validation-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Name&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating mb-3&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Birthday&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Birthday&quot;</span>&gt;&lt;/label&gt;<br>        &lt;span asp-validation-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Birthday&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;&lt;/span&gt;<br>    &lt;/div&gt;<br><br>    ......<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（3）调整Manage文件夹下的Index.cshtml.cs（InputModel类加上三个字段，LoadAsync方法对这三个字段赋值，OnPostAsync方法更新这三个字段）</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InputModel</span><br>&#123;<br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">DataType(DataType.Text)</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Tag&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> CustomTag &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">DataType(DataType.Text)</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Full name&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Birth Date&quot;</span>)</span>]<br>    [<span class="hljs-meta">DataType(DataType.Date)</span>]<br>    <span class="hljs-keyword">public</span> DateTime? Birthday &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;  <span class="hljs-comment">//补充代码</span><br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span>     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span>     directly from your code. This API may change or be removed in future releases.</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">Phone</span>]<br>    [<span class="hljs-meta">Display(Name = <span class="hljs-string">&quot;Phone number&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> PhoneNumber &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">LoadAsync</span>(<span class="hljs-params">ApplicationUser user</span>)</span><br>&#123;<br>    <span class="hljs-keyword">var</span> userName = <span class="hljs-keyword">await</span> _userManager.GetUserNameAsync(user);<br>    <span class="hljs-keyword">var</span> phoneNumber = <span class="hljs-keyword">await</span> _userManager.GetPhoneNumberAsync(user);<br><br>    Username = userName;<br><br>    Input = <span class="hljs-keyword">new</span> InputModel<br>    &#123;<br>        CustomTag = user.CustomTag,  <span class="hljs-comment">//补充代码</span><br>        Name = user.Name,            <span class="hljs-comment">//补充代码</span><br>        Birthday = user.Birthday,    <span class="hljs-comment">//补充代码</span><br>        PhoneNumber = phoneNumber<br>    &#125;;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">OnPostAsync</span>()</span><br>&#123;<br>    <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.GetUserAsync(User);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> NotFound(<span class="hljs-string">$&quot;Unable to load user with ID &#x27;<span class="hljs-subst">&#123;_userManager.GetUserId(User)&#125;</span>&#x27;.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!ModelState.IsValid)<br>    &#123;<br>        <span class="hljs-keyword">await</span> LoadAsync(user);<br>        <span class="hljs-keyword">return</span> Page();<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> phoneNumber = <span class="hljs-keyword">await</span> _userManager.GetPhoneNumberAsync(user);<br>    <span class="hljs-keyword">if</span> (Input.PhoneNumber != phoneNumber)<br>    &#123;<br>        <span class="hljs-keyword">var</span> setPhoneResult = <span class="hljs-keyword">await</span> _userManager.SetPhoneNumberAsync(user, Input.PhoneNumber);<br>        <span class="hljs-keyword">if</span> (!setPhoneResult.Succeeded)<br>        &#123;<br>            StatusMessage = <span class="hljs-string">&quot;Unexpected error when trying to set phone number.&quot;</span>;<br>            <span class="hljs-keyword">return</span> RedirectToPage();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (Input.CustomTag != user.CustomTag)<br>    &#123;<br>        user.CustomTag = Input.CustomTag; <span class="hljs-comment">//补充代码</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (Input.Name != user.Name)<br>    &#123;<br>        user.Name = Input.Name; <span class="hljs-comment">//补充代码</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (Input.Birthday != user.Birthday)<br>    &#123;<br>        user.Birthday = Input.Birthday; <span class="hljs-comment">//补充代码</span><br>    &#125;<br><br>    <span class="hljs-keyword">await</span> _userManager.UpdateAsync(user);  <span class="hljs-comment">//补充代码，更新新增的字段</span><br>    <span class="hljs-keyword">await</span> _signInManager.RefreshSignInAsync(user);<br>    StatusMessage = <span class="hljs-string">&quot;Your profile has been updated&quot;</span>;<br>    <span class="hljs-keyword">return</span> RedirectToPage();<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（4）调整Manage文件夹下的Index.cshtml（视图补充三个字段的输入框）</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;form id=<span class="hljs-string">&quot;profile-form&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>    &lt;div asp-validation-summary=<span class="hljs-string">&quot;ModelOnly&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span> role=<span class="hljs-string">&quot;alert&quot;</span>&gt;&lt;/div&gt;<br><br>    @* 补充代码 *@<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating mb-3&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Username&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> placeholder=<span class="hljs-string">&quot;Please choose your username.&quot;</span> disabled /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Username&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;&lt;/label&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.CustomTag&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.CustomTag&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;&lt;/label&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Name&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Name&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;&lt;/label&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Birthday&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> /&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.Birthday&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;&lt;/label&gt;<br>    &lt;/div&gt;<br><br>    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-floating mb-3&quot;</span>&gt;<br>        &lt;input asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.PhoneNumber&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> placeholder=<span class="hljs-string">&quot;Please enter your phone number.&quot;</span>/&gt;<br>        &lt;label asp-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.PhoneNumber&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;&lt;/label&gt;<br>        &lt;span asp-validation-<span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;Input.PhoneNumber&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;button id=<span class="hljs-string">&quot;update-profile-button&quot;</span> type=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;w-100 btn btn-lg btn-primary&quot;</span>&gt;Save&lt;/button&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>完成以上，启动项目，进入注册页面如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_2_2(3).jpg" srcset="/img/loading.gif" lazyload alt="搭建后注册页面" title="搭建后注册页面"></p>
<p>登录后的用户信息编辑页面如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_2_2(4).jpg" srcset="/img/loading.gif" lazyload alt="搭建后用户信息编辑页面" title="搭建后用户信息编辑页面"></p>
<p>以上就完成了基于 ASP.NET Identity 拓展自定义字段以及支持自定义字段的维护</p>
<h3 id="1-2-3-配置Identity"><a href="#1-2-3-配置Identity" class="headerlink" title="1.2.3.配置Identity"></a>1.2.3.配置Identity</h3><p>在Program类中，补充下列代码：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.Configure&lt;IdentityOptions&gt;(options =&gt;<br>&#123;<br>    <span class="hljs-comment">// Default Password settings.</span><br>    options.Password.RequireDigit = <span class="hljs-literal">true</span>;<br>    options.Password.RequireLowercase = <span class="hljs-literal">true</span>;<br>    options.Password.RequireNonAlphanumeric = <span class="hljs-literal">true</span>;<br>    options.Password.RequireUppercase = <span class="hljs-literal">true</span>;<br>    options.Password.RequiredLength = <span class="hljs-number">6</span>;<br>    options.Password.RequiredUniqueChars = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// Default Lockout settings.</span><br>    options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(<span class="hljs-number">5</span>);<span class="hljs-comment">//密码错误超过次数时的锁定时间</span><br>    options.Lockout.MaxFailedAccessAttempts = <span class="hljs-number">5</span>;<span class="hljs-comment">//密码错误最大允许次数</span><br>    options.Lockout.AllowedForNewUsers = <span class="hljs-literal">true</span>;<br>&#125;);<br><br>builder.Services.ConfigureApplicationCookie(options =&gt;<br>&#123;<br>    options.AccessDeniedPath = <span class="hljs-string">&quot;/Identity/Account/AccessDenied&quot;</span>;<br>    options.Cookie.Name = <span class="hljs-string">&quot;WebMcv1&quot;</span>;<br>    options.Cookie.HttpOnly = <span class="hljs-literal">true</span>;<br>    options.ExpireTimeSpan = TimeSpan.FromMinutes(<span class="hljs-number">5</span>);<span class="hljs-comment">//Cookies过期时间</span><br>    options.LoginPath = <span class="hljs-string">&quot;/Identity/Account/Login&quot;</span>;<br>    <span class="hljs-comment">// ReturnUrlParameter requires </span><br>    <span class="hljs-comment">//using Microsoft.AspNetCore.Authentication.Cookies;</span><br>    options.ReturnUrlParameter = CookieAuthenticationDefaults.ReturnUrlParameter;<br>    options.SlidingExpiration = <span class="hljs-literal">true</span>;<br>&#125;);<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>以上代码表示配置密码的校验规则、用户锁定的方式、Cookies相关配置，用户的锁定配了之后还没完全开启，需要添加Login的基架，登录的OnPostAsync方法中，PasswordSignInAsync的lockoutOnFailure参数设置为true才开启，如下图所示：<br><img src="/../img/StudyAspNetIdentity/img1_2_3.jpg" srcset="/img/loading.gif" lazyload alt="开启用户锁定" title="开启用户锁定"></p>
<br>

<hr>
<br>

<h1 id="2-授权-Authorization"><a href="#2-授权-Authorization" class="headerlink" title="2.授权 Authorization"></a>2.授权 Authorization</h1><h2 id="2-1-简单授权"><a href="#2-1-简单授权" class="headerlink" title="2.1.简单授权"></a>2.1.简单授权</h2><p>（1）在home控制器下Privacy方法加上特性 <code>[Authorize]</code> ，这个方法即需要授权才能登录<br>（2）给整个Home控制器加上特性 <code>[Authorize]</code> ，一启动程序的首页就会需要登录才能进入，给Index和Error方法加上 <code>[AllowAnonymous]</code> ，忽略授权，这样和上一步的效果一致</p>
<br>

<h2 id="2-2-基于角色授权"><a href="#2-2-基于角色授权" class="headerlink" title="2.2.基于角色授权"></a>2.2.基于角色授权</h2><h3 id="2-2-1-建立测试数据"><a href="#2-2-1-建立测试数据" class="headerlink" title="2.2.1.建立测试数据"></a>2.2.1.建立测试数据</h3><p>（1）在注册页面建立三个测试账户，分别是111@111.qq，222@222.qq和333@333.qq<br>（2）建立角色信息和用户角色关联信息，在数据库执行以下脚本</p>
<details><summary>Show Code</summary>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetRoles(Id,Name,NormalizedName)<span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;NormalUserRole&#x27;</span>,<span class="hljs-string">&#x27;NormalUserRole&#x27;</span>)<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetRoles(Id,Name,NormalizedName)<span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;AdminRole&#x27;</span>,<span class="hljs-string">&#x27;AdminRole&#x27;</span>)<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetRoles(Id,Name,NormalizedName)<span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>,<span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>)<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetUserRoles(UserId,RoleId)<span class="hljs-keyword">values</span>((<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetUsers <span class="hljs-keyword">where</span> UserName<span class="hljs-operator">=</span><span class="hljs-string">&#x27;111@111.qq&#x27;</span>),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;NormalUserRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetUserRoles(UserId,RoleId)<span class="hljs-keyword">values</span>((<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetUsers <span class="hljs-keyword">where</span> UserName<span class="hljs-operator">=</span><span class="hljs-string">&#x27;222@222.qq&#x27;</span>),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;AdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> AspNetUserRoles(UserId,RoleId)<span class="hljs-keyword">values</span>((<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetUsers <span class="hljs-keyword">where</span> UserName<span class="hljs-operator">=</span><span class="hljs-string">&#x27;333@333.qq&#x27;</span>),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>执行查询，目前111@111.qq是普通用户角色，222@222.qq是管理员角色，333@333.qq是超级管理员角色</p>
<details><summary>Show Code</summary>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span> t1.UserName,t3.Name <span class="hljs-keyword">as</span> RoleName<br><span class="hljs-keyword">from</span> AspNetUsers <span class="hljs-keyword">as</span> t1<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> AspNetUserRoles <span class="hljs-keyword">as</span> t2 <span class="hljs-keyword">on</span> t2.UserId<span class="hljs-operator">=</span>t1.Id<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> AspNetRoles <span class="hljs-keyword">as</span> t3 <span class="hljs-keyword">on</span> t3.Id<span class="hljs-operator">=</span>t2.RoleId<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t1.UserName,t3.Name<br></code></pre></td></tr></table></figure>

</details>
<br>

<table>
<thead>
<tr>
<th>UserName</th>
<th>RoleName</th>
</tr>
</thead>
<tbody><tr>
<td>111@111.qq</td>
<td>NormalUserRole</td>
</tr>
<tr>
<td>222@222.qq</td>
<td>AdminRole</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
</tr>
</tbody></table>
<br>

<h3 id="2-2-2-建立一个常量类"><a href="#2-2-2-建立一个常量类" class="headerlink" title="2.2.2.建立一个常量类"></a>2.2.2.建立一个常量类</h3><p>在Data文件夹下，新建一个常量Constant类，代码如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Constants</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> NormalUserRole = <span class="hljs-string">&quot;NormalUserRole&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> AdminRole = <span class="hljs-string">&quot;AdminRole&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> SuperAdminRole = <span class="hljs-string">&quot;SuperAdminRole&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> MoreAdmin = <span class="hljs-string">&quot;MoreAdmin&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>假设有三个角色，分别是普通用户角色，管理员角色和超级管理员角色</p>
<h3 id="2-2-3-建立后端测试方法"><a href="#2-2-3-建立后端测试方法" class="headerlink" title="2.2.3.建立后端测试方法"></a>2.2.3.建立后端测试方法</h3><p>在Home控制器加入五个方法，分别是： <strong>TestNormalUserRole</strong> 、 <strong>TestAdminRole</strong> 、 <strong>TestSuperAdminRole</strong> 、 <strong>TestMoreAdminRole</strong> 、 <strong>TestMoreAdminRoleV2</strong></p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C#">[<span class="hljs-meta">Authorize(Roles = Constants.NormalUserRole)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestNormalUserRole</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试按角色请求-NormalUserRole&quot;</span>));<br>&#125;<br><br>[<span class="hljs-meta">Authorize(Roles = Constants.AdminRole)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestAdminRole</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试按角色请求-AdminRole&quot;</span>));<br>&#125;<br><br>[<span class="hljs-meta">Authorize(Roles = Constants.SuperAdminRole)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestSuperAdminRole</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试按角色请求-SuperAdminRole&quot;</span>));<br>&#125;<br><br>[<span class="hljs-meta">Authorize(Roles = $<span class="hljs-string">&quot;&#123;Constants.AdminRole&#125;, &#123;Constants.SuperAdminRole&#125;&quot;</span>)</span>]<span class="hljs-comment">//多个角色可以指定为逗号分隔</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestMoreAdminRole</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试按角色请求-AdminRole个SuperAdminRole&quot;</span>));<br>&#125;<br><br>[<span class="hljs-meta">Authorize(Constants.MoreAdmin)</span>]<span class="hljs-comment">//使用Policy来配置多个角色进行授权</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestMoreAdminRoleV2</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试按角色请求-AdminRole个SuperAdminRole V2&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-2-4-前端视图加上访问请求"><a href="#2-2-4-前端视图加上访问请求" class="headerlink" title="2.2.4.前端视图加上访问请求"></a>2.2.4.前端视图加上访问请求</h3><p>在Privacy.cshtml视图加上访问链接</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestNormalUserRole&quot;</span>&gt;Test Normal User Role&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestAdminRole&quot;</span>&gt;Test Admin Role&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestSuperAdminRole&quot;</span>&gt;Test Super Admin Role&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestMoreAdminRole&quot;</span>&gt;Test More Admin Role&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestMoreAdminRoleV2&quot;</span>&gt;Test More Admin Role V2&lt;/a&gt;<br></code></pre></td></tr></table></figure>

</details>
<br>


<h3 id="2-2-5-配置角色类型"><a href="#2-2-5-配置角色类型" class="headerlink" title="2.2.5.配置角色类型"></a>2.2.5.配置角色类型</h3><p>（1）在Program中配置角色类型</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddDefaultIdentity&lt;ApplicationUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = <span class="hljs-literal">true</span>)<br>    .AddRoles&lt;IdentityRole&gt;()<span class="hljs-comment">//补充代码</span><br>    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（2）使用Policy来配置多个角色进行授权，在Program配置如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddAuthorization(options =&gt;<br>&#123;<br>    options.AddPolicy(Constants.MoreAdmin, policy =&gt; policy.RequireRole(Constants.AdminRole, Constants.SuperAdminRole));<span class="hljs-comment">//使用Policy来配置多个角色进行授权</span><br>&#125;);<br></code></pre></td></tr></table></figure>

</details>
<br>


<h3 id="2-2-6-启动测试"><a href="#2-2-6-启动测试" class="headerlink" title="2.2.6.启动测试"></a>2.2.6.启动测试</h3><p>不同角色的用户只能访问指定自身角色的方法：</p>
<ul>
<li><a href="mailto:&#x31;&#x31;&#49;&#64;&#49;&#49;&#x31;&#x2e;&#113;&#x71;">&#x31;&#x31;&#49;&#64;&#49;&#49;&#x31;&#x2e;&#113;&#x71;</a>用户可以访问 <strong>TestNormalUserRole</strong> 方法；</li>
<li><a href="mailto:&#50;&#x32;&#x32;&#x40;&#50;&#50;&#50;&#46;&#x71;&#x71;">&#50;&#x32;&#x32;&#x40;&#50;&#50;&#50;&#46;&#x71;&#x71;</a>用户可以访问 <strong>TestAdminRole</strong> 、 <strong>TestMoreAdminRole</strong> 和 <strong>TestMoreAdminRoleV2</strong> 方法；</li>
<li><a href="mailto:&#51;&#51;&#51;&#x40;&#x33;&#51;&#x33;&#x2e;&#113;&#113;">&#51;&#51;&#51;&#x40;&#x33;&#51;&#x33;&#x2e;&#113;&#113;</a>用户可以访问 <strong>TestSuperAdminRole</strong> 、 <strong>TestMoreAdminRole</strong> 和 <strong>TestMoreAdminRoleV2</strong> 方法。</li>
</ul>
<p>访问成功如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_2_6(1).jpg" srcset="/img/loading.gif" lazyload alt="角色授权访问成功" title="角色授权访问成功"></p>
<p>访问失败如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_2_6(2).jpg" srcset="/img/loading.gif" lazyload alt="角色授权访问失败" title="角色授权访问失败"></p>
<br>

<h2 id="2-3-自定义授权"><a href="#2-3-自定义授权" class="headerlink" title="2.3.自定义授权"></a>2.3.自定义授权</h2><p>在上一步的基础上再改进，能细到具体权限，不单单指角色，一个角色可以有多个权限</p>
<h3 id="2-3-1-建立权限校验实现类"><a href="#2-3-1-建立权限校验实现类" class="headerlink" title="2.3.1.建立权限校验实现类"></a>2.3.1.建立权限校验实现类</h3><p>在上一步建的常量类中补充其他常量，补充5个权限名称分别是创建、修改、删除、审批、拒绝</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Constants</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OperationName</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Create = <span class="hljs-string">&quot;Create&quot;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Update = <span class="hljs-string">&quot;Update&quot;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Delete = <span class="hljs-string">&quot;Delete&quot;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Approve = <span class="hljs-string">&quot;Approve&quot;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Reject = <span class="hljs-string">&quot;Reject&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> NormalUserRole = <span class="hljs-string">&quot;NormalUserRole&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> AdminRole = <span class="hljs-string">&quot;AdminRole&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> SuperAdminRole = <span class="hljs-string">&quot;SuperAdminRole&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> MoreAdmin = <span class="hljs-string">&quot;MoreAdmin&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>在项目根目录下建一个Authorization文件夹，加三个权限校验规则： <strong>NormalUserAuthorizationHandler</strong> 、 <strong>AdminAuthorizationHandler</strong> 、 <strong>SuperAdminAuthorizationHandler</strong></p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NormalUserAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">OperationAuthorizationRequirement</span>, <span class="hljs-title">string</span>&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;NormalUserAuthorizationHandler&gt; _logger;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NormalUserAuthorizationHandler</span>(<span class="hljs-params">ILogger&lt;NormalUserAuthorizationHandler&gt; logger</span>)</span><br>    &#123;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, <span class="hljs-built_in">string</span> resource</span>)</span><br>    &#123;<br>        _logger.LogInformation(resource);<br><br>        <span class="hljs-keyword">if</span> (context.User == <span class="hljs-literal">null</span> || resource == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!context.User.IsInRole(Constants.NormalUserRole))<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (requirement.Name != Constants.OperationName.Create &amp;&amp;<br>            requirement.Name != Constants.OperationName.Update &amp;&amp;<br>            requirement.Name != Constants.OperationName.Delete)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br><br>        context.Succeed(requirement);<span class="hljs-comment">//如果是普通用户，要有创建，修改，删除权限才能调用</span><br>        <span class="hljs-keyword">return</span> Task.CompletedTask;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AdminAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">OperationAuthorizationRequirement</span>, <span class="hljs-title">string</span>&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;AdminAuthorizationHandler&gt; _logger;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AdminAuthorizationHandler</span>(<span class="hljs-params">ILogger&lt;AdminAuthorizationHandler&gt; logger</span>)</span><br>    &#123;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, <span class="hljs-built_in">string</span> resource</span>)</span><br>    &#123;<br>        _logger.LogInformation(resource);<br><br>        <span class="hljs-keyword">if</span> (context.User == <span class="hljs-literal">null</span> || resource == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(!context.User.IsInRole(Constants.AdminRole))<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (requirement.Name != Constants.OperationName.Approve &amp;&amp;<br>            requirement.Name != Constants.OperationName.Reject)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br><br>        context.Succeed(requirement);<span class="hljs-comment">//如果是管理员用户，要有审批，拒绝权限才能调用</span><br>        <span class="hljs-keyword">return</span> Task.CompletedTask;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SuperAdminAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">OperationAuthorizationRequirement</span>, <span class="hljs-title">string</span>&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;SuperAdminAuthorizationHandler&gt; _logger;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SuperAdminAuthorizationHandler</span>(<span class="hljs-params">ILogger&lt;SuperAdminAuthorizationHandler&gt; logger</span>)</span><br>    &#123;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, <span class="hljs-built_in">string</span> resource</span>)</span><br>    &#123;<br>        _logger.LogInformation(resource);<br><br>        <span class="hljs-keyword">if</span> (context.User == <span class="hljs-literal">null</span> || resource == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!context.User.IsInRole(Constants.SuperAdminRole))<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (requirement.Name != Constants.OperationName.Create &amp;&amp;<br>            requirement.Name != Constants.OperationName.Update &amp;&amp;<br>            requirement.Name != Constants.OperationName.Delete &amp;&amp;<br>            requirement.Name != Constants.OperationName.Approve &amp;&amp;<br>            requirement.Name != Constants.OperationName.Reject)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.CompletedTask;<br>        &#125;<br><br>        context.Succeed(requirement);<span class="hljs-comment">//如果是超级管理员用户，要有创建，修改，删除，审批，拒绝权限才能调用</span><br>        <span class="hljs-keyword">return</span> Task.CompletedTask;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>以上建完项目整体结构如下图所示:<br><img src="/../img/StudyAspNetIdentity/img2_3_1.jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"></p>
<h3 id="2-3-2-建立后端测试方法"><a href="#2-3-2-建立后端测试方法" class="headerlink" title="2.3.2.建立后端测试方法"></a>2.3.2.建立后端测试方法</h3><p><a id="section2_3_2"></a></p>
<p>在Home控制器下增加五个方法 <strong>TestCreate</strong> 、 <strong>TestUpdate</strong> 、 <strong>TestDelete</strong> 、 <strong>TestApprove</strong> 、 <strong>TestReject</strong> ，里面调用 <code>IAuthorizationService.AuthorizeAsync</code> </p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestCreate</span>()</span><br>&#123;<br>    <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> _authorizationService.AuthorizeAsync(User, <span class="hljs-string">&quot;测试&quot;</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Create &#125;);<span class="hljs-comment">//判断这个用户是否有创建权限</span><br>    <span class="hljs-keyword">if</span> (!isAuthorized.Succeeded)<br>    &#123;<br>        <span class="hljs-keyword">return</span> Forbid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> Content(<span class="hljs-string">&quot;测试创建数据&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestUpdate</span>()</span><br>&#123;<br>    <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> _authorizationService.AuthorizeAsync(User, <span class="hljs-string">&quot;测试&quot;</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Update &#125;);<span class="hljs-comment">//判断这个用户是否有修改权限</span><br>    <span class="hljs-keyword">if</span> (!isAuthorized.Succeeded)<br>    &#123;<br>        <span class="hljs-keyword">return</span> Forbid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> Content(<span class="hljs-string">&quot;测试修改数据&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestDelete</span>()</span><br>&#123;<br>    <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> _authorizationService.AuthorizeAsync(User, <span class="hljs-string">&quot;测试&quot;</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Delete &#125;);<span class="hljs-comment">//判断这个用户是否有删除权限</span><br>    <span class="hljs-keyword">if</span> (!isAuthorized.Succeeded)<br>    &#123;<br>        <span class="hljs-keyword">return</span> Forbid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> Content(<span class="hljs-string">&quot;测试删除数据&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestApprove</span>()</span><br>&#123;    <br>    <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> _authorizationService.AuthorizeAsync(User, <span class="hljs-string">&quot;测试&quot;</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Approve &#125;);<span class="hljs-comment">//判断这个用户是否有审批权限</span><br>    <span class="hljs-keyword">if</span> (!isAuthorized.Succeeded)<br>    &#123;<br>        <span class="hljs-keyword">return</span> Forbid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> Content(<span class="hljs-string">&quot;测试审批数据&quot;</span>);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestReject</span>()</span><br>&#123;<br>    <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> _authorizationService.AuthorizeAsync(User, <span class="hljs-string">&quot;测试&quot;</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Reject &#125;);<span class="hljs-comment">//判断这个用户是否有拒绝权限</span><br>    <span class="hljs-keyword">if</span> (!isAuthorized.Succeeded)<br>    &#123;<br>        <span class="hljs-keyword">return</span> Forbid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> Content(<span class="hljs-string">&quot;测试拒绝数据&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-3-3-前端视图加上访问链接"><a href="#2-3-3-前端视图加上访问链接" class="headerlink" title="2.3.3.前端视图加上访问链接"></a>2.3.3.前端视图加上访问链接</h3><p>Privacy.cshtml视图加上访问链接</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestCreate&quot;</span>&gt;Test Create&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestUpdate&quot;</span>&gt;Test Update&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestDelete&quot;</span>&gt;Test Delete&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestApprove&quot;</span>&gt;Test Approve&lt;/a&gt;<br>&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestReject&quot;</span>&gt;Test Reject&lt;/a&gt;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-3-4-在Program中引入"><a href="#2-3-4-在Program中引入" class="headerlink" title="2.3.4.在Program中引入"></a>2.3.4.在Program中引入</h3><details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">// Authorization handlers.</span><br>builder.Services.AddSingleton&lt;IAuthorizationHandler, NormalUserAuthorizationHandler&gt;();<span class="hljs-comment">//引入普通用户授权校验</span><br>builder.Services.AddSingleton&lt;IAuthorizationHandler, AdminAuthorizationHandler&gt;();<span class="hljs-comment">//引入管理员用户授权校验</span><br>builder.Services.AddSingleton&lt;IAuthorizationHandler, SuperAdminAuthorizationHandler&gt;();<span class="hljs-comment">//引入超级管理员授权校验</span><br></code></pre></td></tr></table></figure>
</details>
<br>

<div class="note note-warning">
            <p>注意作为单一实例添加，所需的全部信息都位于 HandleRequirementAsync 方法的 Context 参数中获取到。如果使用了EF等连接数据库的方法，改用AddScoped进行引入</p>
          </div>

<p>目前实现了不同用户可以访问指定权限的方法，</p>
<ul>
<li><a href="mailto:&#49;&#49;&#49;&#x40;&#49;&#49;&#x31;&#46;&#x71;&#x71;">&#49;&#49;&#49;&#x40;&#49;&#49;&#x31;&#46;&#x71;&#x71;</a>用户可以访问 <strong>TestCreate</strong> 、 <strong>TestUpdate</strong> 、 <strong>TestDelete</strong> 方法；</li>
<li><a href="mailto:&#50;&#50;&#50;&#x40;&#x32;&#50;&#50;&#x2e;&#113;&#x71;">&#50;&#50;&#50;&#x40;&#x32;&#50;&#50;&#x2e;&#113;&#x71;</a>用户可以访问 <strong>TestApprove</strong> 、 <strong>TestReject</strong> 方法；</li>
<li><a href="mailto:&#x33;&#51;&#51;&#x40;&#x33;&#x33;&#51;&#46;&#113;&#x71;">&#x33;&#51;&#51;&#x40;&#x33;&#x33;&#51;&#46;&#113;&#x71;</a>用户可以访问全部方法。</li>
</ul>
<p>在三个权限校验类打个断点，会发现，每次访问方法时，三个权限校验类都会执行一遍，只要其中一个类执行到 <code>context.Succeed</code> 即表示可以访问</p>
<div class="note note-warning">
            <p>继承的AuthorizationHandler的TResource泛型可以是任意的，这里的样例使用了string，如果校验逻辑中需要由上文传递一些数据信息，都可以经TResource传入，注意传入的类型要与继承的AuthorizationHandler类中声明的一致，否则不会触发AuthorizationHandler相关继承方法</p>
          </div>

<br>

<h2 id="2-4-自定义特性授权"><a href="#2-4-自定义特性授权" class="headerlink" title="2.4.自定义特性授权"></a>2.4.自定义特性授权</h2><p>在上一步的基础上再次改进，可以通过给方法标记特性的方式进行权限控制</p>
<h3 id="2-4-1-建立新的权限校验规则"><a href="#2-4-1-建立新的权限校验规则" class="headerlink" title="2.4.1.建立新的权限校验规则"></a>2.4.1.建立新的权限校验规则</h3><p>在Authorization文件夹下再增加一个MyAuthorizationHandler类和一个MyAuthorizeAttribute特性</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">MyAuthorizeAttribute</span>&gt;<br>&#123;<br>    ILogger&lt;MyAuthorizationHandler&gt; _logger;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAuthorizationHandler</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;MyAuthorizationHandler&gt; logger</span>)</span><br>    &#123;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, MyAuthorizeAttribute requirement</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> isRequireAll = requirement.RequireAllPermissions;<span class="hljs-comment">//TODO...</span><br><br>        <span class="hljs-keyword">if</span> (context.User.IsInRole(Constants.NormalUserRole))<br>        &#123;<br>            _logger.LogInformation(Constants.NormalUserRole);<br><br>            <span class="hljs-keyword">if</span> (requirement.Permissions.Contains(Constants.OperationName.Create) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Update) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Delete))<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context.User.IsInRole(Constants.AdminRole))<br>        &#123;<br>            _logger.LogInformation(Constants.AdminRole);<br><br>            <span class="hljs-keyword">if</span> (requirement.Permissions.Contains(Constants.OperationName.Approve) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Reject))<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context.User.IsInRole(Constants.SuperAdminRole))<br>        &#123;<br>            _logger.LogInformation(Constants.SuperAdminRole);<br><br>            <span class="hljs-keyword">if</span> (requirement.Permissions.Contains(Constants.OperationName.Create) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Update) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Delete) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Approve) ||<br>                requirement.Permissions.Contains(Constants.OperationName.Reject))<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> Task.CompletedTask;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAuthorizeAttribute</span> : <span class="hljs-title">AuthorizeAttribute</span>, <span class="hljs-title">IAuthorizationRequirement</span>, <span class="hljs-title">IAuthorizationRequirementData</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAuthorizeAttribute</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">string</span>[] permissions</span>)</span><br>    &#123;<br>        Permissions = permissions;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAuthorizeAttribute</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> isRequireAll, <span class="hljs-keyword">params</span> <span class="hljs-built_in">string</span>[] permissions</span>)</span><br>    &#123;<br>        RequireAllPermissions = isRequireAll;<br>        Permissions = permissions;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 声明权限名称</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>[] Permissions &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 必须满足全部权限才能访问</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> RequireAllPermissions &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125; = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;IAuthorizationRequirement&gt; <span class="hljs-title">GetRequirements</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>以上建完项目整体结构如下图所示:<br><img src="/../img/StudyAspNetIdentity/img2_4_1.jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"></p>
<h3 id="2-4-2-方法访问控制"><a href="#2-4-2-方法访问控制" class="headerlink" title="2.4.2.方法访问控制"></a>2.4.2.方法访问控制</h3><p>在Home控制器下增加一个TestRead方法，方法标记特性 <code>[MyAuthorize]</code> 并传入任意数量的权限名称常量</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C#">[<span class="hljs-meta">MyAuthorize(Constants.OperationName.Create, Constants.OperationName.Update, Constants.OperationName.Delete, Constants.OperationName.Approve, Constants.OperationName.Reject)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestRead</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试读取数据&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-4-3-前端视图加上访问链接"><a href="#2-4-3-前端视图加上访问链接" class="headerlink" title="2.4.3.前端视图加上访问链接"></a>2.4.3.前端视图加上访问链接</h3><p>Privacy.cshtml视图加上访问链接</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestRead&quot;</span>&gt;Test Read&lt;/a&gt;<br></code></pre></td></tr></table></figure>

<h3 id="2-4-4-在Program中引入"><a href="#2-4-4-在Program中引入" class="headerlink" title="2.4.4.在Program中引入"></a>2.4.4.在Program中引入</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddScoped&lt;IAuthorizationHandler, MyAuthorizationHandler&gt;();<span class="hljs-comment">//有连接数据库相关方法注入改用AddScoped，不能用AddSingleton</span><br></code></pre></td></tr></table></figure>

<p>在 <a href="#section2_3_2">2.3.2</a> 中添加的5个方法（ <strong>TestCreate</strong> 、 <strong>TestUpdate</strong> 、 <strong>TestDelete</strong> 、 <strong>TestApprove</strong> 、 <strong>TestReject</strong> ）也可以改用标记特性的方式了，去掉里面的 <code>_authorizationService.AuthorizeAsync</code> 方法的相关代码即可。然后原来的三个自定义的权限校验类可以作废使用了（ <strong>NormalUserAuthorizationHandler</strong> 、 <strong>AdminAuthorizationHandler</strong> 、 <strong>SuperAdminAuthorizationHandler</strong> 标记作废，并且把Porgram的引用注释掉）</p>
<p>目前就实现了，根据特性来调用授权逻辑来控制方法的访问权限，可以再进一步优化，特性类中可以增加一个属性RequireAllPermissions，实现是否满足标记的全部权限才能访问。</p>
<blockquote>
<p>注意继承的AuthorizationHandler作为单一实例添加。 它们是单一实例，因为不使用 EF，并且所需的全部信息都位于 HandleRequirementAsync 方法的 Context 参数中。</p>
</blockquote>
<p><strong>（如果要注入UserManager，Program引入时使用AddScoped进行引入）</strong></p>
<br>

<h2 id="2-5-权限实现动态配置"><a href="#2-5-权限实现动态配置" class="headerlink" title="2.5.权限实现动态配置"></a>2.5.权限实现动态配置</h2><p>在上一步的基础上再进一步拓展，实现动态权限配置。将用户，角色，权限都存储于数据库中，通过读取数据库的数据来进行权限控制</p>
<h3 id="2-5-1-增加MyPermission实体"><a href="#2-5-1-增加MyPermission实体" class="headerlink" title="2.5.1.增加MyPermission实体"></a>2.5.1.增加MyPermission实体</h3><p>在Data文件夹下新增MyPermission类</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyPermission</span><br>&#123;<br>    [<span class="hljs-meta">Key</span>]<br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">StringLength(200)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> PermissionId &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    [<span class="hljs-meta">Required</span>]<br>    [<span class="hljs-meta">StringLength(200)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    [<span class="hljs-meta">StringLength(500)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Description &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsActive &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> DateTime CreationTime &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? RoleId &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> IdentityRole? Role &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? UserId &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> ApplicationUser? User &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>ApplicationDbContext引入Dbset</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationDbContext</span> : <span class="hljs-title">IdentityDbContext</span>&lt;<span class="hljs-title">ApplicationUser</span>&gt;<br>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ApplicationDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ApplicationDbContext&gt; options</span>)</span><br><span class="hljs-function">        : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><br>    &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> DbSet&lt;MyPermission&gt; MyPermissions &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125; <span class="hljs-comment">//补充代码</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnModelCreating</span>(<span class="hljs-params">ModelBuilder builder</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.OnModelCreating(builder);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>然后执行迁移 <code>Add-Migration Added_MyPermission</code> 生成迁移日志之后，再执行 <code>Update-Database</code> 更新到数据库中</p>
<h3 id="2-5-2-新增测试数据"><a href="#2-5-2-新增测试数据" class="headerlink" title="2.5.2.新增测试数据"></a>2.5.2.新增测试数据</h3><p>在数据库执行以下脚本，给MyPermissions表插入权限数据，并配置权限给指定的角色</p>
<details><summary>Show Code</summary>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Create&#x27;</span>,N<span class="hljs-string">&#x27;新增权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;NormalUserRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Update&#x27;</span>,N<span class="hljs-string">&#x27;修改权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;NormalUserRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Delete&#x27;</span>,N<span class="hljs-string">&#x27;删除权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;NormalUserRole&#x27;</span>))<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Approve&#x27;</span>,N<span class="hljs-string">&#x27;审批权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;AdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Reject&#x27;</span>,N<span class="hljs-string">&#x27;拒绝权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;AdminRole&#x27;</span>))<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Create&#x27;</span>,N<span class="hljs-string">&#x27;新增权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Update&#x27;</span>,N<span class="hljs-string">&#x27;修改权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Delete&#x27;</span>,N<span class="hljs-string">&#x27;删除权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Approve&#x27;</span>,N<span class="hljs-string">&#x27;审批权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> MyPermissions([PermissionId],[Name],[Description],[IsActive],[CreationTime],[RoleId])<br><span class="hljs-keyword">values</span>(NEWID(),<span class="hljs-string">&#x27;Reject&#x27;</span>,N<span class="hljs-string">&#x27;拒绝权限&#x27;</span>,<span class="hljs-number">1</span>,GETDATE(),(<span class="hljs-keyword">select</span> Id <span class="hljs-keyword">from</span> AspNetRoles <span class="hljs-keyword">where</span> Name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SuperAdminRole&#x27;</span>))<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>查询数据结果</p>
<details><summary>Show Code</summary>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span> t1.UserName,t3.Name <span class="hljs-keyword">as</span> RoleName,t4.Name <span class="hljs-keyword">as</span> PermissionName<br><span class="hljs-keyword">from</span> AspNetUsers <span class="hljs-keyword">as</span> t1<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> AspNetUserRoles <span class="hljs-keyword">as</span> t2 <span class="hljs-keyword">on</span> t2.UserId<span class="hljs-operator">=</span>t1.Id<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> AspNetRoles <span class="hljs-keyword">as</span> t3 <span class="hljs-keyword">on</span> t3.Id<span class="hljs-operator">=</span>t2.RoleId<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> MyPermissions <span class="hljs-keyword">as</span> t4 <span class="hljs-keyword">on</span> t4.RoleId<span class="hljs-operator">=</span>t3.Id <span class="hljs-keyword">and</span> (t4.UserId<span class="hljs-operator">=</span>t1.Id <span class="hljs-keyword">or</span> t4.UserId <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t1.UserName,t3.Name,t4.Name<br></code></pre></td></tr></table></figure>

</details>
<br>

<table>
<thead>
<tr>
<th>UserName</th>
<th>RoleName</th>
<th>PermissionName</th>
</tr>
</thead>
<tbody><tr>
<td>111@111.qq</td>
<td>NormalUserRole</td>
<td>Create</td>
</tr>
<tr>
<td>111@111.qq</td>
<td>NormalUserRole</td>
<td>Delete</td>
</tr>
<tr>
<td>111@111.qq</td>
<td>NormalUserRole</td>
<td>Update</td>
</tr>
<tr>
<td>222@222.qq</td>
<td>AdminRole</td>
<td>Approve</td>
</tr>
<tr>
<td>222@222.qq</td>
<td>AdminRole</td>
<td>Reject</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
<td>Approve</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
<td>Create</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
<td>Delete</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
<td>Reject</td>
</tr>
<tr>
<td>333@333.qq</td>
<td>SuperAdminRole</td>
<td>Update</td>
</tr>
</tbody></table>
<br>

<h3 id="2-5-3-新增权限查询方法"><a href="#2-5-3-新增权限查询方法" class="headerlink" title="2.5.3.新增权限查询方法"></a>2.5.3.新增权限查询方法</h3><p>在Authorization文件夹下建立PermissionManager类</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PermissionManager</span><br>&#123;<br>    ILogger&lt;PermissionManager&gt; _logger;<br>    ApplicationDbContext _context;<br>    UserManager&lt;ApplicationUser&gt; _userManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PermissionManager</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;PermissionManager&gt; logger,</span></span><br><span class="hljs-params"><span class="hljs-function">        ApplicationDbContext context,</span></span><br><span class="hljs-params"><span class="hljs-function">        UserManager&lt;ApplicationUser&gt; userManager</span>)</span><br>    &#123;<br>        _context = context;<br>        _userManager = userManager;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IList&lt;<span class="hljs-built_in">string</span>&gt;&gt; GetAllPermissionByUserIdAsync(ApplicationUser user)<br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">await</span> _userManager.GetRolesAsync(user);<br>            <span class="hljs-keyword">var</span> queryRoleId = _context.Set&lt;IdentityRole&gt;().Where(w =&gt; roles.Any(a =&gt; a == w.Name)).Select(s =&gt; s.Id);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _context.Set&lt;MyPermission&gt;().Where(w =&gt; queryRoleId.Any(a =&gt; a == w.RoleId)).Select(s =&gt; s.Name).ToListAsync();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            _logger.LogError(ex, ex.Message);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-5-4-调整MyAuthorizationHandler权限校验逻辑"><a href="#2-5-4-调整MyAuthorizationHandler权限校验逻辑" class="headerlink" title="2.5.4.调整MyAuthorizationHandler权限校验逻辑"></a>2.5.4.调整MyAuthorizationHandler权限校验逻辑</h3><p>MyAuthorizationHandler类代码全部调整，改为调用PermissionManager</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">MyAuthorizeAttribute</span>&gt;<br>&#123;<br>    ILogger&lt;MyAuthorizationHandler&gt; _logger;<br>    UserManager&lt;ApplicationUser&gt; _userManager;<br>    PermissionManager _permissionManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAuthorizationHandler</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;MyAuthorizationHandler&gt; logger,</span></span><br><span class="hljs-params"><span class="hljs-function">        UserManager&lt;ApplicationUser&gt; userManager,</span></span><br><span class="hljs-params"><span class="hljs-function">        PermissionManager permissionManager</span>)</span><br>    &#123;<br>        _logger = logger;<br>        _userManager = userManager;<br>        _permissionManager = permissionManager;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, MyAuthorizeAttribute requirement</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (context.User == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.GetUserAsync(context.User);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<span class="hljs-comment">//用户没有登录需要登录</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (requirement.Permissions.Length == <span class="hljs-number">0</span>)<br>        &#123;<br>            context.Succeed(requirement);<span class="hljs-comment">//当没有标记权限时，只要验证登录即可访问</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> permissions = <span class="hljs-keyword">await</span> _permissionManager.GetAllPermissionByUserIdAsync(user);<br>        <span class="hljs-keyword">if</span> (permissions.Count == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        _logger.LogInformation(<span class="hljs-string">$&quot;当前用户拥有的权限：<span class="hljs-subst">&#123;<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;|&quot;</span>, permissions)&#125;</span>&quot;</span>);<br><br>        <span class="hljs-keyword">var</span> isRequireAll = requirement.RequireAllPermissions;<br>        <span class="hljs-keyword">var</span> intersectList = requirement.Permissions.Intersect(permissions).ToList();<span class="hljs-comment">//接口要求的权限和用户拥有的权限交集</span><br>        <span class="hljs-keyword">if</span> (isRequireAll)<br>        &#123;<br>            <span class="hljs-comment">//要满足标记的全部权限才能通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count == requirement.Permissions.Length)<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">//只要满足至少一个权限即可通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-5-5-在Program中引入"><a href="#2-5-5-在Program中引入" class="headerlink" title="2.5.5.在Program中引入"></a>2.5.5.在Program中引入</h3><p>MyAuthorizationHandler的引入如果之前是使用AddSingleton方法的改为使用AddScoped</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddScoped&lt;IAuthorizationHandler, MyAuthorizationHandler&gt;();<span class="hljs-comment">//有连接数据库相关方法注入改用AddScoped，不能用AddSingleton</span><br>builder.Services.AddTransient(<span class="hljs-keyword">typeof</span>(PermissionManager));<span class="hljs-comment">//引入权限管理类</span><br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-5-6-增加测试方法"><a href="#2-5-6-增加测试方法" class="headerlink" title="2.5.6.增加测试方法"></a>2.5.6.增加测试方法</h3><p>在Home控制器下，新增TestReadV2方法，特性使用的是必须满足全部权限才能访问</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C#">[<span class="hljs-meta">MyAuthorize(true, Constants.OperationName.Create, Constants.OperationName.Update, Constants.OperationName.Approve)</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">TestReadV2</span>()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(Content(<span class="hljs-string">&quot;测试读取数据V2&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-5-7-前端视图加上访问请求"><a href="#2-5-7-前端视图加上访问请求" class="headerlink" title="2.5.7.前端视图加上访问请求"></a>2.5.7.前端视图加上访问请求</h3><p>Privacy.cshtml视图加上访问链接</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">&lt;a <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link text-dark&quot;</span> asp-area=<span class="hljs-string">&quot;&quot;</span> asp-controller=<span class="hljs-string">&quot;Home&quot;</span> asp-action=<span class="hljs-string">&quot;TestReadV2&quot;</span>&gt;Test Read V2&lt;/a&gt;<br></code></pre></td></tr></table></figure>

<p>完成以上项目整体结构如下图所示:<br><img src="/../img/StudyAspNetIdentity/img2_5_7.jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"></p>
<p>以上就完成了，标记特性的方法会根据当前登录的用户，查询数据库对应的权限，并校验是否有方法标记的权限，有就能访问，否则就无法访问</p>
<br>

<h2 id="2-6-实现视图的权限控制"><a href="#2-6-实现视图的权限控制" class="headerlink" title="2.6.实现视图的权限控制"></a>2.6.实现视图的权限控制</h2><h3 id="2-6-1-增加视图校验类"><a href="#2-6-1-增加视图校验类" class="headerlink" title="2.6.1.增加视图校验类"></a>2.6.1.增加视图校验类</h3><p>在Authorization文件夹下增加一个MyViewAuthorizationHandler类</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyViewAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">OperationAuthorizationRequirement</span>, <span class="hljs-title">bool</span>&gt;<br>&#123;<br>    ILogger&lt;MyViewAuthorizationHandler&gt; _logger;<br>    UserManager&lt;ApplicationUser&gt; _userManager;<br>    PermissionManager _permissionManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyViewAuthorizationHandler</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;MyViewAuthorizationHandler&gt; logger,</span></span><br><span class="hljs-params"><span class="hljs-function">        UserManager&lt;ApplicationUser&gt; userManager,</span></span><br><span class="hljs-params"><span class="hljs-function">        PermissionManager permissionManager</span>)</span><br>    &#123;<br>        _logger = logger;<br>        _userManager = userManager;<br>        _permissionManager = permissionManager;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, <span class="hljs-built_in">bool</span> isRequireAll</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (context.User == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.GetUserAsync(context.User);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<span class="hljs-comment">//用户没有登录需要登录</span><br>        &#125;<br><br>        <span class="hljs-keyword">var</span> userPermissions = <span class="hljs-keyword">await</span> _permissionManager.GetAllPermissionByUserIdAsync(user);<br>        <span class="hljs-keyword">if</span> (userPermissions.Count == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        _logger.LogInformation(<span class="hljs-string">$&quot;当前用户拥有的权限：<span class="hljs-subst">&#123;<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;|&quot;</span>, userPermissions)&#125;</span>&quot;</span>);<br><br>        <span class="hljs-keyword">var</span> requestPermissions = requirement.Name.Split(<span class="hljs-string">&#x27;,&#x27;</span>);<br>        <span class="hljs-keyword">var</span> intersectList = requestPermissions.Intersect(userPermissions).ToList();<span class="hljs-comment">//视图要求的权限和用户拥有的权限交集</span><br>        <span class="hljs-keyword">if</span> (isRequireAll)<br>        &#123;<br>            <span class="hljs-comment">//要满足标记的全部权限才能通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count == requestPermissions.Length)<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">//只要满足至少一个权限即可通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                context.Succeed(requirement);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-6-2-调整Privacy视图"><a href="#2-6-2-调整Privacy视图" class="headerlink" title="2.6.2.调整Privacy视图"></a>2.6.2.调整Privacy视图</h3><p>对Privacy视图增加权限控制，满足权限的才显示对应的元素标签，Privacy.cshtml视图的代码调整如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs C#">@&#123;<br>    ViewData[<span class="hljs-string">&quot;Title&quot;</span>] = <span class="hljs-string">&quot;Privacy Policy&quot;</span>;<br>&#125;<br>@using Microsoft.AspNetCore.Authorization<br>@using Microsoft.AspNetCore.Authorization.Infrastructure<br>@using WebMvc1.Data<br>@inject IAuthorizationService AuthorizationService<br><br>&lt;h1&gt;@ViewData[<span class="hljs-string">&quot;Title&quot;</span>]&lt;/h1&gt;<br><br>&lt;p&gt;Use <span class="hljs-keyword">this</span> page to detail your site<span class="hljs-string">&#x27;s privacy policy.&lt;/p&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Create &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestCreate&quot;&gt;Test Create&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Update &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestUpdate&quot;&gt;Test Update&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Delete &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestDelete&quot;&gt;Test Delete&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Approve &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestApprove&quot;&gt;Test Approve&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = Constants.OperationName.Reject &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestReject&quot;&gt;Test Reject&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, false, new OperationAuthorizationRequirement &#123; Name = $&quot;&#123;Constants.OperationName.Create&#125;,&#123;Constants.OperationName.Update&#125;,&#123;Constants.OperationName.Delete&#125;,&#123;Constants.OperationName.Approve&#125;,&#123;Constants.OperationName.Reject&#125;&quot; &#125;)).Succeeded)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestRead&quot;&gt;Test Read&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await AuthorizationService.AuthorizeAsync(User, true, new OperationAuthorizationRequirement &#123; Name = $&quot;&#123;Constants.OperationName.Create&#125;,&#123;Constants.OperationName.Update&#125;,&#123;Constants.OperationName.Approve&#125;&quot; &#125;)).Succeeded)//resource传true，自定义表示要满足全部权限才能通过</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestReadV2&quot;&gt;Test Read V2&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

</details>
<br>

<h3 id="2-6-3-在Program中引入"><a href="#2-6-3-在Program中引入" class="headerlink" title="2.6.3.在Program中引入"></a>2.6.3.在Program中引入</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddScoped&lt;IAuthorizationHandler, MyViewAuthorizationHandler&gt;();<span class="hljs-comment">//引入视图授权校验</span><br></code></pre></td></tr></table></figure>

<p>完成以上三部启动项目即可查看到效果，三个账户都登录一次，验证一下是否只有对应权限才会显示对应的标签</p>
<ul>
<li>作为普通用户角色的<a href="mailto:&#x31;&#x31;&#x31;&#64;&#x31;&#x31;&#x31;&#46;&#113;&#113;">&#x31;&#x31;&#x31;&#64;&#x31;&#x31;&#x31;&#46;&#113;&#113;</a>用户看到的视图如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_6_3(1).jpg" srcset="/img/loading.gif" lazyload alt="普通用户视图" title="普通用户视图"></li>
<li>作为管理员角色的<a href="mailto:&#x32;&#x32;&#50;&#64;&#x32;&#50;&#x32;&#46;&#x71;&#113;">&#x32;&#x32;&#50;&#64;&#x32;&#50;&#x32;&#46;&#x71;&#113;</a>用户看到的视图如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_6_3(2).jpg" srcset="/img/loading.gif" lazyload alt="管理员视图" title="管理员视图"></li>
<li>作为超级管理员角色的<a href="mailto:&#x33;&#51;&#x33;&#x40;&#x33;&#51;&#x33;&#46;&#x71;&#113;">&#x33;&#51;&#x33;&#x40;&#x33;&#51;&#x33;&#46;&#x71;&#113;</a>用户看到的视图如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_6_3(3).jpg" srcset="/img/loading.gif" lazyload alt="超级管理员视图" title="超级管理员视图"></li>
</ul>
<h3 id="2-6-4-代码优化"><a href="#2-6-4-代码优化" class="headerlink" title="2.6.4.代码优化"></a>2.6.4.代码优化</h3><p>在视图中调用的方法可见，其实和 <a href="#section2_3_2">2.3.2</a> 中控制器方法调用的校验完全一样，都是通过调用IAuthorizationService接口的AuthorizeAsync方法，触发MyViewAuthorizationHandler授权校验类的代码来进行控制。但是这样视图的写法过于复杂，而且会发现MyViewAuthorizationHandler类的写法和MyAuthorizationHandler的写法基本差不多，所以在此基础上可以再进一步封装，具体改造如下：</p>
<h4 id="2-6-4-1-优化第一步"><a href="#2-6-4-1-优化第一步" class="headerlink" title="2.6.4.1.优化第一步"></a>2.6.4.1.优化第一步</h4><p>重构MyAuthorizationHandler、MyViewAuthorizationHandler和PermissionManager三个类，相同的逻辑封装一个方法，具体代码调整如下：</p>
<p>（1）PermissionManager类代码调整如下，主要增加一个IsHasPermissionAsync方法：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PermissionManager</span><br>&#123;<br>    ILogger&lt;PermissionManager&gt; _logger;<br>    ApplicationDbContext _context;<br>    UserManager&lt;ApplicationUser&gt; _userManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PermissionManager</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;PermissionManager&gt; logger,</span></span><br><span class="hljs-params"><span class="hljs-function">        ApplicationDbContext context,</span></span><br><span class="hljs-params"><span class="hljs-function">        UserManager&lt;ApplicationUser&gt; userManager</span>)</span><br>    &#123;<br>        _context = context;<br>        _userManager = userManager;<br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IList&lt;<span class="hljs-built_in">string</span>&gt;&gt; GetAllPermissionByUserIdAsync(ApplicationUser user)<br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">await</span> _userManager.GetRolesAsync(user);<br>            <span class="hljs-keyword">var</span> queryRoleId = _context.Set&lt;IdentityRole&gt;().Where(w =&gt; roles.Any(a =&gt; a == w.Name)).Select(s =&gt; s.Id);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _context.Set&lt;MyPermission&gt;().Where(w =&gt; queryRoleId.Any(a =&gt; a == w.RoleId)).Select(s =&gt; s.Name).ToListAsync();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            _logger.LogError(ex, ex.Message);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">IsHasPermissionAsync</span>(<span class="hljs-params">ClaimsPrincipal claimsPrincipal, <span class="hljs-built_in">string</span>[] requestPermissions, <span class="hljs-built_in">bool</span> isRequireAll</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (claimsPrincipal == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.GetUserAsync(claimsPrincipal);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<span class="hljs-comment">//用户没有登录需要登录</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (requestPermissions.Length == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<span class="hljs-comment">//当没有标记权限时，只要验证登录即可访问</span><br>        &#125;<br><br>        <span class="hljs-keyword">var</span> permissions = <span class="hljs-keyword">await</span> GetAllPermissionByUserIdAsync(user);<br>        <span class="hljs-keyword">if</span> (permissions.Count == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        _logger.LogInformation(<span class="hljs-string">$&quot;当前用户拥有的权限：<span class="hljs-subst">&#123;<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;|&quot;</span>, permissions)&#125;</span>&quot;</span>);<br><br>        <span class="hljs-keyword">var</span> intersectList = requestPermissions.Intersect(permissions).ToList();<span class="hljs-comment">//请求的权限和用户拥有的权限交集</span><br>        <span class="hljs-keyword">if</span> (isRequireAll)<br>        &#123;<br>            <span class="hljs-comment">//要满足标记的全部权限才能通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count == requestPermissions.Length)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">//只要满足至少一个权限即可通过</span><br>            <span class="hljs-keyword">if</span> (intersectList.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（2）MyAuthorizationHandler类代码调整如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">MyAuthorizeAttribute</span>&gt;<br>&#123;<br>    PermissionManager _permissionManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAuthorizationHandler</span>(<span class="hljs-params">PermissionManager permissionManager</span>)</span><br>    &#123;<br>        _permissionManager = permissionManager;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, MyAuthorizeAttribute requirement</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> isHasPermission = <span class="hljs-keyword">await</span> _permissionManager.IsHasPermissionAsync(context.User, requirement.Permissions, requirement.RequireAllPermissions);<br>        <span class="hljs-keyword">if</span> (isHasPermission)<br>        &#123;<br>            context.Succeed(requirement);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（3）MyViewAuthorizationHandler类代码调整如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyViewAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">OperationAuthorizationRequirement</span>, <span class="hljs-title">bool</span>&gt;<br>&#123;<br>    PermissionManager _permissionManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyViewAuthorizationHandler</span>(<span class="hljs-params">PermissionManager permissionManager</span>)</span><br>    &#123;<br>        _permissionManager = permissionManager;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, <span class="hljs-built_in">bool</span> isRequireAll</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> isHasPermission =  <span class="hljs-keyword">await</span> _permissionManager.IsHasPermissionAsync(context.User, requirement.Name.Split(<span class="hljs-string">&#x27;,&#x27;</span>), isRequireAll);<br>        <span class="hljs-keyword">if</span> (isHasPermission)<br>        &#123;<br>            context.Succeed(requirement);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<h4 id="2-6-4-2-优化第二步"><a href="#2-6-4-2-优化第二步" class="headerlink" title="2.6.4.2.优化第二步"></a>2.6.4.2.优化第二步</h4><p>封装一个给视图用的公共的权限校验方法，避免每次需要权限校验都要注入接口声明，每次调用授权方法传参的麻烦</p>
<p>在Views文件夹下新加类MyRazorPage</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyRazorPage</span>&lt;<span class="hljs-title">TModel</span>&gt; : <span class="hljs-title">RazorPage</span>&lt;<span class="hljs-title">TModel</span>&gt;<br>&#123;<br>    [<span class="hljs-meta">RazorInject</span>]<br>    <span class="hljs-keyword">public</span> IAuthorizationService AuthorizationService &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">IsHasPermissionAsync</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">string</span>[] permissions</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> AuthorizationService.AuthorizeAsync(User, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = <span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;,&quot;</span>, permissions) &#125;);<br>        <span class="hljs-keyword">return</span> isAuthorized.Succeeded;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">IsHasPermissionAsync</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> isRequireAll, <span class="hljs-keyword">params</span> <span class="hljs-built_in">string</span>[] permissions</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> isAuthorized = <span class="hljs-keyword">await</span> AuthorizationService.AuthorizeAsync(User, isRequireAll, <span class="hljs-keyword">new</span> OperationAuthorizationRequirement &#123; Name = <span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;,&quot;</span>, permissions) &#125;);<br>        <span class="hljs-keyword">return</span> isAuthorized.Succeeded;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>视图_ViewImports.cshtml补充代码，增加对MyRazorPage类的引用</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C#">@using WebMvc1<br>@using WebMvc1.Models<br>@using WebMvc1.Views<span class="hljs-comment">//补充代码</span><br>@inherits MyRazorPage&lt;TModel&gt;<span class="hljs-comment">//补充代码</span><br>@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers<br></code></pre></td></tr></table></figure>

<p>调整视图Privacy.cshtml的代码如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs C#">@&#123;<br>    ViewData[<span class="hljs-string">&quot;Title&quot;</span>] = <span class="hljs-string">&quot;Privacy Policy&quot;</span>;<br>&#125;<br>@using WebMvc1.Data<br><br>&lt;h1&gt;@ViewData[<span class="hljs-string">&quot;Title&quot;</span>]&lt;/h1&gt;<br><br>&lt;p&gt;Use <span class="hljs-keyword">this</span> page to detail your site<span class="hljs-string">&#x27;s privacy policy.&lt;/p&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Create)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestCreate&quot;&gt;Test Create&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Update)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestUpdate&quot;&gt;Test Update&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Delete)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestDelete&quot;&gt;Test Delete&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Approve)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestApprove&quot;&gt;Test Approve&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Reject)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestReject&quot;&gt;Test Reject&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(Constants.OperationName.Create, Constants.OperationName.Update, Constants.OperationName.Delete, Constants.OperationName.Approve, Constants.OperationName.Reject)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestRead&quot;&gt;Test Read&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">@if ((await IsHasPermissionAsync(true, Constants.OperationName.Create, Constants.OperationName.Update, Constants.OperationName.Approve)))</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &lt;a class=&quot;nav-link text-dark&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;TestReadV2&quot;&gt;Test Read V2&lt;/a&gt;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

</details>
<br>

<h4 id="2-6-4-3-优化第三步"><a href="#2-6-4-3-优化第三步" class="headerlink" title="2.6.4.3.优化第三步"></a>2.6.4.3.优化第三步</h4><p>使用缓存，减少数据库的查询次数，这里使用的是.NET自带的内存缓存来实现</p>
<p>（1）安装NuGet包：Microsoft.Extensions.Caching.Memory<br>（2）在Program中引入</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">builder.Services.AddMemoryCache();<span class="hljs-comment">//引入内存缓存</span><br></code></pre></td></tr></table></figure>
<p>（3）调整PermissionManager类的GetAllPermissionByUserIdAsync方法，如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs C#"><br>IMemoryCache _memoryCache;<span class="hljs-comment">//注入接口</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PermissionManager</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">    ......</span></span><br><span class="hljs-params"><span class="hljs-function">    IMemoryCache memoryCache</span>)</span><br>&#123;<br>    ......<br>    _memoryCache = memoryCache;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IList&lt;<span class="hljs-built_in">string</span>&gt;&gt; GetAllPermissionByUserIdAsync(ApplicationUser user)<br>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> list = _memoryCache.Get&lt;IList&lt;<span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-string">$&quot;UserPermission:<span class="hljs-subst">&#123;user.Id&#125;</span>&quot;</span>);<br>        <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> list;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">await</span> _userManager.GetRolesAsync(user);<br>        <span class="hljs-keyword">var</span> queryRoleId = _context.Set&lt;IdentityRole&gt;().Where(w =&gt; roles.Any(a =&gt; a == w.Name)).Select(s =&gt; s.Id);<br>        list = <span class="hljs-keyword">await</span> _context.Set&lt;MyPermission&gt;().Where(w =&gt; queryRoleId.Any(a =&gt; a == w.RoleId)).Select(s =&gt; s.Name).ToListAsync();<br><br>        DateTime expireTime = DateTime.Now.AddMinutes(<span class="hljs-number">5</span>);<span class="hljs-comment">//设置缓存有效期</span><br>        _memoryCache.Set(<span class="hljs-string">$&quot;UserPermission:<span class="hljs-subst">&#123;user.Id&#125;</span>&quot;</span>, list, expireTime);<br>        <span class="hljs-comment">//_memoryCache.Remove($&quot;UserPermission:&#123;user.Id&#125;&quot;);//若以后开发了可以在前端配置用户角色和权限信息时，配置以后记得清除缓存</span><br><br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception ex)<br>    &#123;<br>        _logger.LogError(ex, ex.Message);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>以上增加了内存缓存功能，当查询过一次之后，在有效期内再次查询时如果是同一个Key则直接返回结果，不需要再执行查询数据库的那段代码了，提供查询效率。</p>
<h4 id="2-6-4-4-优化第四步"><a href="#2-6-4-4-优化第四步" class="headerlink" title="2.6.4.4.优化第四步"></a>2.6.4.4.优化第四步</h4><p>关于注入声明，可以实现批量注入。按目前项目Program中声明的 PermissionManager 类，如果后续有更多类似的Manager类建立，每次都要在这里注入就非常的麻烦，而且Program会增加维护成本，后期可能会很难维护，为了避免这个问题可以采用反射的方式，统一获取这些需要注入的类或接口，然后遍历统一去做注入，实现方法如下：</p>
<p>（1）建立三个接口，首先在根目录建一个文件夹Dependency，然后文件夹下面建三个接口类，分别是：IScopeDependency、ISingletonDependency、ITransientDependency，建好三个接口即可，接口里面不需要写代码。<br>（2）建一个RegisterDependencyService类，用于拓展IServiceCollection，具体实现批量注入的地方。</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RegisterDependencyService</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">AddDependencyService</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span><br>    &#123;<br>        <span class="hljs-comment">//获取当前项目下继承于IScopeDependency、ISingletonDependency、ITransientDependency三个接口的所有实现类</span><br>        <span class="hljs-keyword">var</span> implementTypes = Directory.GetFiles(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string">&quot;*.dll&quot;</span>)<br>            .Where(w =&gt; Regex.IsMatch(Path.GetFileName(w), <span class="hljs-string">$&quot;^<span class="hljs-subst">&#123;AppDomain.CurrentDomain.FriendlyName&#125;</span>.*&quot;</span>, RegexOptions.IgnoreCase | RegexOptions.Compiled))<br>            .Select(Assembly.LoadFrom)<br>            .SelectMany(a =&gt; a.DefinedTypes)<br>            .Select(type =&gt; type.AsType())<br>            .Where(x =&gt; x.IsClass)<br>            .Where(x =&gt; <span class="hljs-keyword">typeof</span>(IScopeDependency).IsAssignableFrom(x) || <span class="hljs-keyword">typeof</span>(ISingletonDependency).IsAssignableFrom(x) || <span class="hljs-keyword">typeof</span>(ITransientDependency).IsAssignableFrom(x))<br>            .ToList();<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> implementType <span class="hljs-keyword">in</span> implementTypes)<br>        &#123;<br>            <span class="hljs-comment">//获取该类型实现的接口数组</span><br>            <span class="hljs-keyword">var</span> interfaces = implementType.GetInterfaces();<br>            <span class="hljs-comment">//如果该类的接口类除了默认的IScopeDependency、ISingletonDependency、ITransientDependency以外还有继承其他接口，则按接口的方式来注入，否则只注入自己的实现</span><br>            <span class="hljs-keyword">var</span> interfaceType = interfaces.Where(w =&gt; w != <span class="hljs-keyword">typeof</span>(IScopeDependency) &amp;&amp; w != <span class="hljs-keyword">typeof</span>(ISingletonDependency) &amp;&amp; w != <span class="hljs-keyword">typeof</span>(ITransientDependency)).FirstOrDefault(x =&gt; x.IsAssignableFrom(implementType));<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(IScopeDependency).IsAssignableFrom(implementType))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (interfaceType != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    services.AddScoped(interfaceType, implementType);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    services.AddScoped(implementType);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(ISingletonDependency).IsAssignableFrom(implementType))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (interfaceType != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    services.AddSingleton(interfaceType, implementType);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    services.AddSingleton(implementType);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(ITransientDependency).IsAssignableFrom(implementType))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (interfaceType != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    services.AddTransient(interfaceType, implementType);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    services.AddTransient(implementType);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> services;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>（3）为实现类标记注入方式的接口</p>
<ul>
<li>a.给 PermissionManager 实现类加上继承 ITransientDependency 接口</li>
<li>b.给 MyAuthorizationHandler 实现类加上继承 IScopeDependency 接口</li>
<li>c.给 MyViewAuthorizationHandler 实现类也加上继承 IScopeDependency 接口</li>
</ul>
<p>（4）在Program中调用AddDependencyService方法，然后可以注释掉原来的相关的注入语句</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//builder.Services.AddScoped&lt;IAuthorizationHandler, MyViewAuthorizationHandler&gt;();//引入视图授权校验</span><br><span class="hljs-comment">//builder.Services.AddScoped&lt;IAuthorizationHandler, MyAuthorizationHandler&gt;();//有连接数据库相关方法注入改用AddScoped，不能用AddSingleton</span><br><span class="hljs-comment">//builder.Services.AddTransient(typeof(PermissionManager));//引入权限管理类</span><br>builder.Services.AddDependencyService();<br></code></pre></td></tr></table></figure>

<p>以上便实现了批量自动注入，以后要是需要注入时，直接继承三个类型的其中一个接口，实现类需要按哪种依赖生命周期就继承哪个接口即可。（后续可以给 PermissionManager 再加个接口类 IPermissionManager ，然后把原来的 ITransientDependency 给 IPermissionManager 继承， PermissionManager 再继承 IPermissionManager，这样更符号按接口方式实现的标准）</p>
<div class="note note-secondary">
            <p>关于AddTransient、AddSingleton、AddScoped的区别<br>AddTransient： 每次service请求都是获得不同的实例，暂时性模式：暂时性对象始终不同，无论是不是同一个请求（同一个请求里的不同服务）同一个客户端，每次都是创建新的实例；<br>AddScoped： 对于同一个请求返回同一个实例，不同的请求返回不同的实例，作用域模式：作用域对象在一个客户端请求中是相同的，但在多个客户端请求中是不同的；<br>AddSingleton： 每次都是获得同一个实例， 单一实例模式：单一实例对象对每个对象和每个请求都是相同的，可以说是不同客户端不同请求都是相同的；</p><p>AddTransient的生命周期：请求获取-（GC回收-主动释放），每一次获取的对象都不是同一个<br>AddScoped的生命周期：请求开始-请求结束，在这次请求中获取的对象都是同一个<br>AddSingleton的生命周期：项目启动-项目关闭，相当于静态类，只会有一个<br>–参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/AnAng/p/9370913.html">https://www.cnblogs.com/AnAng/p/9370913.html</a></p>
          </div>


<h2 id="2-7-实现前端js的权限控制"><a href="#2-7-实现前端js的权限控制" class="headerlink" title="2.7.实现前端js的权限控制"></a>2.7.实现前端js的权限控制</h2><h3 id="2-7-1-搭建后端接口"><a href="#2-7-1-搭建后端接口" class="headerlink" title="2.7.1.搭建后端接口"></a>2.7.1.搭建后端接口</h3><p>在控制器文件夹下，新建一个控制器JavaScriptsController类，代码如下：</p>
<details><summary>Show Code</summary>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JavaScriptsController</span> : <span class="hljs-title">Controller</span><br>&#123;<br>    ILogger&lt;JavaScriptsController&gt; _logger;<br>    PermissionManager _permissionManager;<br>    UserManager&lt;ApplicationUser&gt; _userManager;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JavaScriptsController</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        ILogger&lt;JavaScriptsController&gt; logger,</span></span><br><span class="hljs-params"><span class="hljs-function">        PermissionManager permissionManager,</span></span><br><span class="hljs-params"><span class="hljs-function">        UserManager&lt;ApplicationUser&gt; userManager</span>)</span><br>    &#123;<br>        _logger = logger;<br>        _permissionManager = permissionManager;<br>        _userManager = userManager;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;ActionResult&gt; <span class="hljs-title">GetAllScripts</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> minify = <span class="hljs-literal">false</span></span>)</span><br>    &#123;<br>        ApplicationUser? user = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (User != <span class="hljs-literal">null</span>)<br>        &#123;<br>            user = <span class="hljs-keyword">await</span> _userManager.GetUserAsync(User);<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> sb = <span class="hljs-keyword">new</span> StringBuilder();<br><br>        sb.AppendLine(<span class="hljs-keyword">await</span> GetPermissionScripts(user));<span class="hljs-comment">//获取用户所有权限</span><br>        sb.AppendLine();<br>        sb.AppendLine(GetConstantOperationNameScripts());<span class="hljs-comment">//获取常量字符串</span><br>        sb.AppendLine();<br>        sb.AppendLine(GetUserInfoAsync(user));<span class="hljs-comment">//获取用户信息</span><br>        sb.AppendLine();<br><br>        <span class="hljs-keyword">return</span> Content(minify ? Minify(sb.ToString()) : sb.ToString(), <span class="hljs-string">&quot;application/x-javascript&quot;</span>, Encoding.UTF8);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetPermissionScripts</span>(<span class="hljs-params">ApplicationUser? user</span>)</span><br>    &#123;<br>        IList&lt;<span class="hljs-built_in">string</span>&gt; allPermissionNames;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>        &#123;<br>            allPermissionNames = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();<span class="hljs-comment">//用户没有登录需要登录</span><br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            allPermissionNames = <span class="hljs-keyword">await</span> _permissionManager.GetAllPermissionByUserIdAsync(user);<br>        &#125;<br>        <br>        <span class="hljs-keyword">var</span> script = <span class="hljs-keyword">new</span> StringBuilder();<br>        script.AppendLine(<span class="hljs-string">&quot;(function()&#123;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">&quot;  webmvc1.permission = webmvc1.permission || &#123;&#125;;&quot;</span>);<span class="hljs-comment">//给全局webmvc1参数绑定permission对象</span><br>        script.AppendLine(<span class="hljs-string">&quot;    webmvc1.permission.values = &#123;&quot;</span>);<span class="hljs-comment">//给webmvc1.permission对象绑定values对象</span><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> permissionName <span class="hljs-keyword">in</span> allPermissionNames)<br>        &#123;<br>            script.AppendLine(<span class="hljs-string">$&quot;      &#x27;<span class="hljs-subst">&#123;permissionName&#125;</span>&#x27;: true,&quot;</span>);<br>        &#125;<br>        script.AppendLine(<span class="hljs-string">&quot;    &#125;;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">&quot;    webmvc1.permission.isGranted = function (permissionName) &#123; return webmvc1.permission.values[permissionName] != undefined; &#125;;&quot;</span>);<br>        script.Append(<span class="hljs-string">&quot;&#125;)();&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> script.ToString();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetConstantOperationNameScripts</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> script = <span class="hljs-keyword">new</span> StringBuilder();<br>        script.AppendLine(<span class="hljs-string">&quot;(function()&#123;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">&quot;  webmvc1.constant = webmvc1.constant || &#123;&#125;;&quot;</span>);<span class="hljs-comment">//给全局webmvc1参数绑定constant对象</span><br>        script.AppendLine(<span class="hljs-string">&quot;  webmvc1.constant.operationName = webmvc1.constant.operationName || &#123;&#125;;&quot;</span>);<span class="hljs-comment">//给webmvc1.constant对象绑定operationName对象</span><br>        <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">typeof</span>(Constants.OperationName);<br>        <span class="hljs-keyword">var</span> fields = type.GetFields();<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> field <span class="hljs-keyword">in</span> fields)<br>        &#123;<br>            script.AppendLine(<span class="hljs-string">$&quot;    webmvc1.constant.operationName.<span class="hljs-subst">&#123;field.Name.ToLower()&#125;</span> = &#x27;<span class="hljs-subst">&#123;field.GetRawConstantValue()&#125;</span>&#x27;;&quot;</span>);<br>        &#125;<br>        script.Append(<span class="hljs-string">&quot;&#125;)();&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> script.ToString();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetUserInfoAsync</span>(<span class="hljs-params">ApplicationUser? user</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> script = <span class="hljs-keyword">new</span> StringBuilder();<br>        script.AppendLine(<span class="hljs-string">&quot;(function()&#123;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">&quot;  webmvc1.userInfo = webmvc1.userInfo || &#123;&#125;;&quot;</span>);<span class="hljs-comment">//给全局webmvc1参数绑定userInfo对象</span><br>        script.AppendLine(<span class="hljs-string">$&quot;  webmvc1.userInfo.id = &#x27;<span class="hljs-subst">&#123;user.Id&#125;</span>&#x27;;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">$&quot;  webmvc1.userInfo.userName = &#x27;<span class="hljs-subst">&#123;user.UserName&#125;</span>&#x27;;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">$&quot;  webmvc1.userInfo.name = &#x27;<span class="hljs-subst">&#123;user.Name&#125;</span>&#x27;;&quot;</span>);<br>        script.AppendLine(<span class="hljs-string">$&quot;  webmvc1.userInfo.customTag = &#x27;<span class="hljs-subst">&#123;user.CustomTag&#125;</span>&#x27;;&quot;</span>);<br>        script.Append(<span class="hljs-string">&quot;&#125;)();&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> script.ToString();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Minify</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> javaScriptCode</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(javaScriptCode))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">var</span> result = Uglify.Js(javaScriptCode);<br>        <span class="hljs-keyword">if</span> (!result.HasErrors)<br>        &#123;<br>            <span class="hljs-keyword">return</span> result.Code;<br>        &#125;<br><br>        _logger.LogWarning(<span class="hljs-string">$&quot;Minify has encountered an error in handling javascript.&quot;</span>);<br>        result.Errors.ForEach(error =&gt; _logger.LogWarning(error.ToString()));<br><br>        <span class="hljs-keyword">return</span> javaScriptCode;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>以上代码需要额外安装一个NuGet包：NUglify，支持js压缩</p>
<h3 id="2-7-2-前端引入"><a href="#2-7-2-前端引入" class="headerlink" title="2.7.2.前端引入"></a>2.7.2.前端引入</h3><p>（1）_Layout.cshtml文件引入js，在视图的底部引入，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C#">@* 引入后端生成的权限校验方法 minify=<span class="hljs-literal">true</span>表示生成压缩版本的js*@<br>&lt;script src=<span class="hljs-string">&quot;~/JavaScripts/GetAllScripts?minify=true&amp;v=@(DateTime.Now.Ticks)&quot;</span> type=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p>（2）在site.js（wwwroot&#x2F;js&#x2F;site.js）中声明一个全局公共参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> webmvc1 = webmvc1 || &#123;&#125;;<span class="hljs-comment">//声明一个全局参数</span><br></code></pre></td></tr></table></figure>

<p>（3）在js文件夹下，建立一个Home文件夹，在Home文件夹下再建立一个privacy.js文件，同时在Privacy.cshtml视图引入privacy.js文件，在Privacy.cshtml视图底部补充以下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C#">@section scripts &#123;<br>    &lt;script src=<span class="hljs-string">&quot;~/js/Home/privacy.js&quot;</span> asp-append-version=<span class="hljs-string">&quot;true&quot;</span>&gt;&lt;/script&gt;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-7-3-测试结果"><a href="#2-7-3-测试结果" class="headerlink" title="2.7.3.测试结果"></a>2.7.3.测试结果</h3><p>以上完成了js判断权限的功能搭建，可以启动项目，并在上一步增加的privacy.js文件中，补充下列测试代码：</p>
<details><summary>Show Code</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//测试</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;UserName&quot;</span>, webmvc1.<span class="hljs-property">userInfo</span>.<span class="hljs-property">userName</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">create</span>, webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">create</span>));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">update</span>, webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">update</span>));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">delete</span>, webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">delete</span>));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">approve</span>, webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">approve</span>));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">reject</span>, webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">reject</span>));<br><br>    <span class="hljs-keyword">if</span> (webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-title function_">isGranted</span>(webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">create</span>)) &#123;<br>        <span class="hljs-comment">//TODO...</span><br>    &#125;<br>&#125;)();<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>启动后，登录用户并访问Privacy视图，打开浏览器控制台（一般浏览器使用快捷键F12即可打开），可以看到输出的对应用户的权限，如下图所示：<br><img src="/../img/StudyAspNetIdentity/img2_7_3(1).jpg" srcset="/img/loading.gif" lazyload alt="js权限控制" title="js权限控制"></p>
<p>本质上就是后端构造一个js文件，里面生成好权限、常量、用户信息相关的数据和方法，代码如下所示：</p>
<details><summary>Show Code</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  webmvc1.<span class="hljs-property">permission</span> = webmvc1.<span class="hljs-property">permission</span> || &#123;&#125;;<br>    webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-property">values</span> = &#123;<br>      <span class="hljs-string">&#x27;Approve&#x27;</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-string">&#x27;Reject&#x27;</span>: <span class="hljs-literal">true</span>,<br>    &#125;;<br>    webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-property">isGranted</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">permissionName</span>) &#123; <span class="hljs-keyword">return</span> webmvc1.<span class="hljs-property">permission</span>.<span class="hljs-property">values</span>[permissionName] != <span class="hljs-literal">undefined</span>; &#125;;<br>&#125;)();<br><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  webmvc1.<span class="hljs-property">constant</span> = webmvc1.<span class="hljs-property">constant</span> || &#123;&#125;;<br>  webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span> = webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span> || &#123;&#125;;<br>    webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">create</span> = <span class="hljs-string">&#x27;Create&#x27;</span>;<br>    webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">update</span> = <span class="hljs-string">&#x27;Update&#x27;</span>;<br>    webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">delete</span> = <span class="hljs-string">&#x27;Delete&#x27;</span>;<br>    webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">approve</span> = <span class="hljs-string">&#x27;Approve&#x27;</span>;<br>    webmvc1.<span class="hljs-property">constant</span>.<span class="hljs-property">operationName</span>.<span class="hljs-property">reject</span> = <span class="hljs-string">&#x27;Reject&#x27;</span>;<br>&#125;)();<br><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  webmvc1.<span class="hljs-property">userInfo</span> = webmvc1.<span class="hljs-property">userInfo</span> || &#123;&#125;;<br>  webmvc1.<span class="hljs-property">userInfo</span>.<span class="hljs-property">id</span> = <span class="hljs-string">&#x27;8b53f7e4-26b5-4171-8414-37053005d2fa&#x27;</span>;<br>  webmvc1.<span class="hljs-property">userInfo</span>.<span class="hljs-property">userName</span> = <span class="hljs-string">&#x27;222@222.qq&#x27;</span>;<br>  webmvc1.<span class="hljs-property">userInfo</span>.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;Test2&#x27;</span>;<br>  webmvc1.<span class="hljs-property">userInfo</span>.<span class="hljs-property">customTag</span> = <span class="hljs-string">&#x27;测试2&#x27;</span>;<br>&#125;)();<br></code></pre></td></tr></table></figure>

</details>
<br>

<p>最终项目整体结构如下图所示:<br><img src="/../img/StudyAspNetIdentity/img2_7_3(2).jpg" srcset="/img/loading.gif" lazyload alt="项目结构" title="项目结构"></p>
<br>

<h1 id="demo链接"><a href="#demo链接" class="headerlink" title="demo链接"></a>demo链接</h1><p>Github代码-MyUserManagerProject <a target="_blank" rel="noopener" href="https://github.com/YuMan-LJP/demo">https://github.com/YuMan-LJP/demo</a></p>
<br>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>微软学习文档-验证 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/aspnet/core/security/authentication">https://learn.microsoft.com/zh-cn/aspnet/core/security/authentication</a><br>微软学习文档-授权 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/aspnet/core/security/authorization">https://learn.microsoft.com/zh-cn/aspnet/core/security/authorization</a><br>AddTransient、AddSingleton、AddScoped的区别 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/AnAng/p/9370913.html">https://www.cnblogs.com/AnAng/p/9370913.html</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/ASP-NET%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="category-chain-item">ASP.NET相关技术学习总结</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ASP-NET-Identity/" class="print-no-link">#ASP.NET Identity</a>
      
        <a href="/tags/%E8%AE%A4%E8%AF%81/" class="print-no-link">#认证</a>
      
        <a href="/tags/%E6%8E%88%E6%9D%83/" class="print-no-link">#授权</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【2】学习ASP.NET Identity，搭建一套简易权限控制系统</div>
      <div>http://example.com/2023/12/29/StudyAspNetIdentity/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>YuMan-LJP</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月29日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/10/StudyVueIdentityServer4/" title="【3】学习IdentityServer4，搭建授权认证系统">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【3】学习IdentityServer4，搭建授权认证系统</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/23/Common-Script-Commands/" title="常用脚本命令汇总">
                        <span class="hidden-mobile">常用脚本命令汇总</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
